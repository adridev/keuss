(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{69:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return o})),t.d(n,"metadata",(function(){return l})),t.d(n,"rightToc",(function(){return p})),t.d(n,"default",(function(){return s}));var i=t(2),r=t(6),a=(t(0),t(96)),o={id:"building",title:"Building Pipelines",sidebar_label:"Building"},l={unversionedId:"usage/pipelines/building",id:"usage/pipelines/building",isDocsHomePage:!1,title:"Building Pipelines",description:"Pipelines can be built in 3 ways:",source:"@site/docs/usage/pipelines/building.md",slug:"/usage/pipelines/building",permalink:"/keuss/docs/usage/pipelines/building",editUrl:"https://github.com/pepmartinez/keuss/edit/master/website/docs/usage/pipelines/building.md",version:"current",sidebar_label:"Building",sidebar:"someSidebar",previous:{title:"Processors",permalink:"/keuss/docs/usage/pipelines/processors"},next:{title:"Examples",permalink:"/keuss/docs/usage/pipelines/examples"}},p=[{value:"Direct Pipeline Creation",id:"direct-pipeline-creation",children:[]},{value:"Creation with a <code>PipelineBuilder</code>",id:"creation-with-a-pipelinebuilder",children:[{value:"Pipepine object",id:"pipepine-object",children:[]}]},{value:"Creation with <code>Factory.pipelineFromRecipe</code>",id:"creation-with-factorypipelinefromrecipe",children:[]}],c={rightToc:p};function s(e){var n=e.components,t=Object(r.a)(e,["components"]);return Object(a.b)("wrapper",Object(i.a)({},c,t,{components:n,mdxType:"MDXLayout"}),Object(a.b)("p",null,"Pipelines can be built in 3 ways:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"By directly creating queues and processors, and bonding them together. This is rather low-level and is not the recommended way"),Object(a.b)("li",{parentName:"ul"},"By using a ",Object(a.b)("inlineCode",{parentName:"li"},"PipelineBuilder"),". This object provides a fluent API that's convenient and very simple. This is the recommended way to created pipelines in code"),Object(a.b)("li",{parentName:"ul"},"By using the method ",Object(a.b)("inlineCode",{parentName:"li"},"pipelineFromRecipe")," offered by the Queues Factories supporting pipelining. This allows a whole pipeline to be defined in a set of strings and therefore in external files; this makes pipelies portable, reproductible and totally cluster-ready")),Object(a.b)("h2",{id:"direct-pipeline-creation"},"Direct Pipeline Creation"),Object(a.b)("p",null,"This is a quite simple approach: you create the queues, then you create the Processors that would glue them. Processors take i theit constructors the queues they use, so it's rather straightforward:"),Object(a.b)("pre",null,Object(a.b)("code",Object(i.a)({parentName:"pre"},{className:"language-javascript"}),"const MQ =  require ('../../../backends/pl-mongo');\nconst DCT = require ('../../../Pipeline/DirectLink');\nconst SNK = require ('../../../Pipeline/Sink');\nconst CHC = require ('../../../Pipeline/ChoiceLink');\n\nfunction sink_process (elem, done) {\n  // define processing for Sinks\n}\n\nconst factory_opts = {\n  // ...\n};\n\n// initialize factory\nMQ (factory_opts, (err, factory) => {\n  if (err) return console.error (err);\n\n  // factory ready, create queues on default pipeline\n  const q_opts = {aaa: 666, b: 'yy'};\n  const q1 = factory.queue ('pl_many_q_1', q_opts);\n  const q2 = factory.queue ('pl_many_q_2', q_opts);\n  const q3 = factory.queue ('pl_many_q_3', q_opts);\n  const q4 = factory.queue ('pl_many_q_4', q_opts);\n  const q5 = factory.queue ('pl_many_q_5', q_opts);\n\n  // tie them up:\n  const dl1 = new DCT (q1, q2);\n  const cl1 = new CHC (q2, [q3, q4, q5]);\n  const sk1 = new SNK (q3);\n  const sk2 = new SNK (q4);\n  const sk3 = new SNK (q5);\n\n  sk1.on_data (sink_process);\n  sk2.on_data (sink_process);\n  sk3.on_data (sink_process);\n\n  cl1.on_data (function (elem, done) {\n    // define processing for the ChoiceLink\n  });\n\n  dl1.on_data (function (elem, done) {\n    // define processing for the DirectLink\n  });\n\n  // start the whole lot\n  sk1.start ();\n  sk2.start ();\n  sk3.start ();\n  cl1.start ();\n  dl1.start ();\n\n  // pipeline is ready now. Push stuff to queues, see it work\n});\n\n")),Object(a.b)("p",null,"See ",Object(a.b)("a",Object(i.a)({parentName:"p"},{href:"/keuss/docs/usage/pipelines/processors"}),"Processors")," for all the available options and features (such as processing functions and error management)"),Object(a.b)("h2",{id:"creation-with-a-pipelinebuilder"},"Creation with a ",Object(a.b)("inlineCode",{parentName:"h2"},"PipelineBuilder")),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},"PipelineBuilder")," provides a simpler way to create pipelines using a fluent api. Builders are obtained through ",Object(a.b)("inlineCode",{parentName:"p"},"factory.builder()")," and offers the following methods:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"pipeline(name)"),": initializes a pipeline, passing a name to it. Must be called before any other method, and can be called only once"),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"queue(name, opts)"),": creates a queue and adds it to the pipeline"),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"directLink (name_src_q, name_dst_q, process_fn)"),": creates a DirectLink linking queues src_q and dst_q (specified by name), using the process function ",Object(a.b)("inlineCode",{parentName:"li"},"process_fn")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"choiceLink(name_src_q, [name_dst_q1, name_dst_q2, ...name_dst_qn], process_fn)"),": creates a ChoiceLink linking src_q and the array of dst_q (specified by name), using the process function ",Object(a.b)("inlineCode",{parentName:"li"},"process_fn")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"sink(name_src_q, process_fn)"),": creates a Sink on queue src_q (specified by name), using the process function ",Object(a.b)("inlineCode",{parentName:"li"},"process_fn")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"onError(fn)"),": sets the ",Object(a.b)("inlineCode",{parentName:"li"},"error")," event handler for all processirs created in the pipeline. As with the error handler for Processors, ",Object(a.b)("inlineCode",{parentName:"li"},"fn")," will receive a single param with the error; in this case the error will be augmented by adding an extra field ",Object(a.b)("inlineCode",{parentName:"li"},"processor"),", which will be areference to the ",Object(a.b)("inlineCode",{parentName:"li"},"Processor")," object originating the error"),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"done(err, pipeline)"),": finished the pipeline creation. No other calls can be done to the builder afterwards. In case of error, the error will be passed in ",Object(a.b)("inlineCode",{parentName:"li"},"err"),"; if all went well ",Object(a.b)("inlineCode",{parentName:"li"},"err")," will be ",Object(a.b)("inlineCode",{parentName:"li"},"null")," and the newly created pipeline, an object of type ",Object(a.b)("inlineCode",{parentName:"li"},"Pipeline"),", will be passed in the ",Object(a.b)("inlineCode",{parentName:"li"},"pipeline"),"; all further interactions with the pipeline will happen through this object")),Object(a.b)("h3",{id:"pipepine-object"},"Pipepine object"),Object(a.b)("p",null,"The new Pipeline object exports the following methods:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"start()"),": starts the pipeline (simply calls ",Object(a.b)("inlineCode",{parentName:"li"},"start()")," on all processors)"),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"stop()"),": stops the pipeline (simply calls ",Object(a.b)("inlineCode",{parentName:"li"},"stop()")," on all processors)")),Object(a.b)("p",null,"Here's a simplified example (for a complete, working example see ",Object(a.b)("a",Object(i.a)({parentName:"p"},{href:"https://github.com/pepmartinez/keuss/tree/master/examples/pipelines/builder"}),"here"),"):"),Object(a.b)("pre",null,Object(a.b)("code",Object(i.a)({parentName:"pre"},{className:"language-javascript"}),"MQ (factory_opts, (err, factory) => {\n  if (err) return console.error (err);\n  const q_opts = {};\n\n  factory\n  .builder ()\n  .pipeline ('the-pipeline')\n  .queue ('test_pl_1', q_opts)\n  .queue ('test_pl_2', q_opts)\n  .queue ('test_pl_3', q_opts)\n  .queue ('test_pl_4', q_opts)\n  .queue ('test_pl_5', q_opts)\n  .directLink ('test_pl_1', 'test_pl_2', dl_process)\n  .choiceLink ('test_pl_2', ['test_pl_3', 'test_pl_4', 'test_pl_5'], choice_process)\n  .sink ('test_pl_3', sink_process)\n  .sink ('test_pl_4', sink_process)\n  .sink ('test_pl_5', sink_process)\n  .onError (console.log)\n  .done ((err, pl) => {\n    if (err) return console.error (err);\n    // pipeline pl is ready\n    pl.start ();\n    // pipeline pl is running\n  });\n});\n")),Object(a.b)("h2",{id:"creation-with-factorypipelinefromrecipe"},"Creation with ",Object(a.b)("inlineCode",{parentName:"h2"},"Factory.pipelineFromRecipe")),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},"Factory.pipelineFromRecipe")," provides a way to define pipelines entirely from strings, including queue, processors, the functions\nto be used as process functions and all the code used on those functions. In this way a full, self-contained pipeline can be specified\nin a file or set of files"),Object(a.b)("p",null,"Under the hood it uses ",Object(a.b)("a",Object(i.a)({parentName:"p"},{href:"https://nodejs.org/dist/latest-v12.x/docs/api/vm.html"}),"node.js VM module")," to create the ",Object(a.b)("inlineCode",{parentName:"p"},"Pipeline")," object: once created it can be used normally outside of the creation VM"),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},"Factory.pipelineFromRecipe")," is provided only on factories created from backends with pipelining support. This single method take the following parameters:"),Object(a.b)("pre",null,Object(a.b)("code",Object(i.a)({parentName:"pre"},{className:"language-javascript"}),"Factory.pipelineFromRecipe (\n  pipeline_name,\n  array_of_bootstrap_code,\n  array_of_setup_code,\n  extra_context,\n  done\n)\n")),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},"A new VM is created using the merge of the default context and the parameter ",Object(a.b)("inlineCode",{parentName:"li"},"extra_context"),". The default context contains the following:",Object(a.b)("ul",{parentName:"li"},Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"Buffer")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"require")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"clearImmediate"),", ",Object(a.b)("inlineCode",{parentName:"li"},"clearInterval"),", ",Object(a.b)("inlineCode",{parentName:"li"},"clearTimeout"),", ",Object(a.b)("inlineCode",{parentName:"li"},"setImmediate"),", ",Object(a.b)("inlineCode",{parentName:"li"},"setTimeout"),", ",Object(a.b)("inlineCode",{parentName:"li"},"setInterval")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"TextEncoder"),", ",Object(a.b)("inlineCode",{parentName:"li"},"TextDecoder")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"URL"),", ",Object(a.b)("inlineCode",{parentName:"li"},"URLSearchParams")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"builder"),": an already initialized builder object, as in ",Object(a.b)("inlineCode",{parentName:"li"},"factory.builder ().pipeline (name)")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"done"),": a function to call when the pipeline is ready, or an error arises. Expects to be ",Object(a.b)("inlineCode",{parentName:"li"},"fn (err, pipeline)")))),Object(a.b)("li",{parentName:"ol"},"Each of the strings in the ",Object(a.b)("inlineCode",{parentName:"li"},"array_of_bootstrap_code")," is executed in the VM"),Object(a.b)("li",{parentName:"ol"},"Each of the strings in the ",Object(a.b)("inlineCode",{parentName:"li"},"array_of_setup_code")," is executed in the VM. It is expected to eventually call ",Object(a.b)("inlineCode",{parentName:"li"},"done")," with the error or the finished pipeline (",Object(a.b)("inlineCode",{parentName:"li"},"done"),"is accesible in the context)")),Object(a.b)("p",null,"The whole idea is to prepare all the needed code for processors' functions in the ",Object(a.b)("inlineCode",{parentName:"p"},"array_of_bootstrap_code"),", then create the pipeline in the ",Object(a.b)("inlineCode",{parentName:"p"},"array_of_setup_code"),", calling the ",Object(a.b)("inlineCode",{parentName:"p"},"done")," function whith the created pipeline"),Object(a.b)("p",null,"You can find a full example ",Object(a.b)("a",Object(i.a)({parentName:"p"},{href:"https://github.com/pepmartinez/keuss/tree/master/examples/pipelines/fromRecipe"}),"here")))}s.isMDXComponent=!0},96:function(e,n,t){"use strict";t.d(n,"a",(function(){return b})),t.d(n,"b",(function(){return m}));var i=t(0),r=t.n(i);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function p(e,n){if(null==e)return{};var t,i,r=function(e,n){if(null==e)return{};var t,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var c=r.a.createContext({}),s=function(e){var n=r.a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},b=function(e){var n=s(e.components);return r.a.createElement(c.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.a.createElement(r.a.Fragment,{},n)}},u=r.a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,a=e.originalType,o=e.parentName,c=p(e,["components","mdxType","originalType","parentName"]),b=s(t),u=i,m=b["".concat(o,".").concat(u)]||b[u]||d[u]||a;return t?r.a.createElement(m,l(l({ref:n},c),{},{components:t})):r.a.createElement(m,l({ref:n},c))}));function m(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var a=t.length,o=new Array(a);o[0]=u;var l={};for(var p in n)hasOwnProperty.call(n,p)&&(l[p]=n[p]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var c=2;c<a;c++)o[c]=t[c];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,t)}u.displayName="MDXCreateElement"}}]);