(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{76:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return s})),a.d(t,"metadata",(function(){return i})),a.d(t,"rightToc",(function(){return o})),a.d(t,"default",(function(){return u}));var n=a(2),r=a(6),l=(a(0),a(90)),s={id:"queue",title:"Queue API",sidebar_label:"Queue"},i={unversionedId:"api/queue",id:"api/queue",isDocsHomePage:!1,title:"Queue API",description:"Get Stats",source:"@site/docs/api/queue.md",permalink:"/keuss/docs/api/queue",editUrl:"https://github.com/pepmartinez/keuss/edit/master/website/docs/api/queue.md",sidebar_label:"Queue",sidebar:"someSidebar",previous:{title:"Stats API",permalink:"/keuss/docs/api/stats"},next:{title:"Examples",permalink:"/keuss/docs/examples"}},o=[],c={rightToc:o};function u(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(l.b)("wrapper",Object(n.a)({},c,a,{components:t,mdxType:"MDXLayout"}),Object(l.b)("h4",{id:"get-stats"},"Get Stats"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"q.stats ((err, res) => {\n  ...\n})\n")),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},"res contains usage stats (elements insterted, elements extracted, paused status)")),Object(l.b)("h4",{id:"queue-name"},"Queue name"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"var qname = q.name ()\n")),Object(l.b)("h4",{id:"queue-type"},"Queue type"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"var qtype = q.type ()\n")),Object(l.b)("p",null,"returns a string with the type of the queue (the type of backend which was used to create it)"),Object(l.b)("h4",{id:"queue-occupation"},"Queue occupation"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"q.size ((err, res) => {\n  ...\n})\n")),Object(l.b)("p",null,"returns the number of elements in the queue that are already elligible (that is, excluding scheduled elements with a schedule time in the future)"),Object(l.b)("h4",{id:"total-queue-occupation"},"Total Queue occupation"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"q.totalSize ((err, res) => {\n  ...\n})\n")),Object(l.b)("p",null,"returns the number of elements in the queue (that is, including scheduled elements with a schedule time in the future)"),Object(l.b)("h4",{id:"size-of-scheduled"},"Size of Scheduled"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"q.schedSize ((err, res) => {\n  ...\n})\n")),Object(l.b)("p",null,"returns the number of scheduled elements in the queue (that is, those with a schedule time in the future). Returns 0 id the queue does not support scheduling"),Object(l.b)("h4",{id:"size-of-reserved"},"Size of Reserved"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"q.resvSize ((err, res) => {\n  ...\n})\n")),Object(l.b)("p",null,"returns the number of reserved elements in the queue. REturns ",Object(l.b)("inlineCode",{parentName:"p"},"null")," if the queue does not support reserve"),Object(l.b)("h4",{id:"pauseresume"},"Pause/Resume"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"// pauses the queue\nq.pause (true)\n\n// resumes the queue\nq.pause (false)\n\n// gets paused status of queue\nq.paused ((err, is_paused) => {\n  ...\n})\n")),Object(l.b)("p",null,"Pauses/Resumes all consumers on this queue (calls to pop()). Producers are not afected (calls to push())"),Object(l.b)("p",null,"The pause/resume condition is propagated via the signallers, so this affects all consumers, not only those local to the process, if a redis-pubsub or mongo-capped signaller is used"),Object(l.b)("p",null,"Also, the paused condition is stored as stats, so any new call to pop() will honor it"),Object(l.b)("h4",{id:"time-of-schedule-of-next-message"},"Time of schedule of next message"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"q.next_t ((err, res) => {\n  ...\n})\n")),Object(l.b)("p",null,"Returns a Date, or null if queue is empty. Queues with no support for schedule/delay always return null"),Object(l.b)("h4",{id:"add-element-to-queue"},"Add element to queue"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"q.push (payload, [opts,] (err, res) => {\n  ...\n})\n")),Object(l.b)("p",null,"Adds payload to the queue, calls passed callback upon completion. Callback's ",Object(l.b)("em",{parentName:"p"},"res")," will contain the id assigned to the inserted element, if the backup provides one"),Object(l.b)("p",null,"Possible opts:"),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},Object(l.b)("strong",{parentName:"li"},"mature"),": unix timestamp where the element would be elligible for extraction. It is guaranteed that the element won't be extracted before this time"),Object(l.b)("li",{parentName:"ul"},Object(l.b)("strong",{parentName:"li"},"delay"),": delay in seconds to calculate the mature timestamp, if mature is not provided. For example, a delay=120 guarantees the element won't be extracted until 120 secs have elapsed ",Object(l.b)("em",{parentName:"li"},"at least")),Object(l.b)("li",{parentName:"ul"},Object(l.b)("strong",{parentName:"li"},"tries"),": value to initialize the retry counter, defaults to 0 (still no retries).")),Object(l.b)("p",null,Object(l.b)("em",{parentName:"p"},"note"),": mature and delay have no effect if the backend does not support delay/schedule"),Object(l.b)("h4",{id:"get-element-from-queue"},"Get element from queue"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"var tr = q.pop (cid, [opts,] (err, res) => {\n  ...\n})\n")),Object(l.b)("p",null,"Obtains an element from the queue. Callback is called with the element obtained if any, or if an error happened. If defined, the operation will wait for ",Object(l.b)("em",{parentName:"p"},"opts.timeout")," seconds for an element to appear in the queue before bailing out (with both err and res being null). However, it immediately returns an id that can be used to cancel the operation at anytime"),Object(l.b)("p",null,Object(l.b)("em",{parentName:"p"},"cid")," is an string that identifies the consumer entity; it is used only for debugging purposes"),Object(l.b)("p",null,"Possible opts:"),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},Object(l.b)("strong",{parentName:"li"},"timeout"),": milliseconds to wait for an elligible element to appear in the queue to be returned. If not defined it will wait forever"),Object(l.b)("li",{parentName:"ul"},Object(l.b)("strong",{parentName:"li"},"reserve"),": if true the element is only reserved, not completely returned. This means either ",Object(l.b)("em",{parentName:"li"},"ok")," or ",Object(l.b)("em",{parentName:"li"},"ko")," operations are needed upon the obtained element once processed, otherwise the element will be rolled back (and made available again) at some point in the future (this is only available on backends capable of reserve/commit)")),Object(l.b)("h4",{id:"cancel-a-pending-pop"},"Cancel a pending Pop"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"var tr = q.pop (cid, opts, (err, res) => {...});\n.\n.\n.\nq.cancel (tr);\n")),Object(l.b)("p",null,"Cancels a pending pop operation, identified by the value returned by pop()"),Object(l.b)("p",null,"If no tr is passed, or it is null, all pending pop operations on the queue are cancelled. Cancelled pop operations will get 'cancel' (a string) as error in the callback"),Object(l.b)("h4",{id:"commit-a-reserved-element"},"Commit a reserved element"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"q.ok (id, (err, res) => {\n  ...\n})\n")),Object(l.b)("p",null,"commits a reserved element by its id (the id would be at res._id on the res param of pop() operation). This effectively erases the element from the queue."),Object(l.b)("p",null,"Alternatively, you can pass the entire ",Object(l.b)("inlineCode",{parentName:"p"},"res")," object from the ",Object(l.b)("inlineCode",{parentName:"p"},"pop()")," operation:"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"var tr = q.pop ('my-consumer-id', {reserve: true}, (err, res) => {\n  // do something with res\n  ...\n\n  // commit it\n  q.ok (res, (err, res) => {\n    ...\n  });\n});\n")),Object(l.b)("h4",{id:"rolls-back-a-reserved-element"},"Rolls back a reserved element"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"q.ko (id, next_t, (err, res) => {\n  ...\n})\n")),Object(l.b)("p",null,"rolls back a reserved element by its id (the id would be at res._id on the res param of pop() operation). This effectively makes the element available again at the queue, marking to be mature at next_t (next_t being a millsec-unixtime). If no next_t is specified or a null is passed, ",Object(l.b)("inlineCode",{parentName:"p"},"now()")," is assumed."),Object(l.b)("p",null,"As with ",Object(l.b)("inlineCode",{parentName:"p"},"ok()"),", you can use the entire ",Object(l.b)("inlineCode",{parentName:"p"},"res")," instead:"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"var tr = q.pop ('my-consumer-id', {reserve: true}, (err, res) => {\n  // do something with res\n  ...\n\n  // commit or rollback it\n  if (succeed) q.ok (res, (err, res) => {\n    ...\n  })\n  else q.ko (res, (err, res) => {\n    ...\n  })\n});\n")),Object(l.b)("p",null,"NOTE: you must pass the entire ",Object(l.b)("inlineCode",{parentName:"p"},"res")," for the deadletter feature to work; even if activated at the factory, ",Object(l.b)("inlineCode",{parentName:"p"},"ko()")," will not honor deadletter if you only pass the ",Object(l.b)("inlineCode",{parentName:"p"},"res._id")," as ",Object(l.b)("inlineCode",{parentName:"p"},"id")),Object(l.b)("h4",{id:"drain-queue"},"Drain queue"),Object(l.b)("pre",null,Object(l.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"q.drain (err => {\n  ...\n})\n")),Object(l.b)("p",null,"drains a queue. This is a needed operation when a backend does read-ahead upon a pop(), or buffers push() operations for later; in this case, you may want to be sure that all extra elemens read are actually popped, and all pending pushes are committed."),Object(l.b)("p",null,"'drain' will immediately inhibit push(): any call to push() will immediately result in a 'drain' (a string) error. The callback will be called when all pending pushes are committed, and all read-ahead on a pop() has been actually popped."),Object(l.b)("p",null,"Also, drain() will also call cancel() on the queue immediately before finishing, in case of success."))}u.isMDXComponent=!0},90:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return m}));var n=a(0),r=a.n(n);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){l(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var c=r.a.createContext({}),u=function(e){var t=r.a.useContext(c),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=u(e.components);return r.a.createElement(c.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=r.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,l=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),p=u(a),d=n,m=p["".concat(s,".").concat(d)]||p[d]||b[d]||l;return a?r.a.createElement(m,i(i({ref:t},c),{},{components:a})):r.a.createElement(m,i({ref:t},c))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var l=a.length,s=new Array(l);s[0]=d;var i={};for(var o in t)hasOwnProperty.call(t,o)&&(i[o]=t[o]);i.originalType=e,i.mdxType="string"==typeof e?e:n,s[1]=i;for(var c=2;c<l;c++)s[c]=a[c];return r.a.createElement.apply(null,s)}return r.a.createElement.apply(null,a)}d.displayName="MDXCreateElement"}}]);